import commonOptionBuilder from '#cli/builders/commonOptionBuilder';
import documentOptionBuilder from '#cli/builders/documentOptionBuilder';
import htmlOptionBuilder from '#cli/builders/htmlOptionBuilder';
import imageOptionBuilder from '#cli/builders/imageOptionBuilder';
import markdownOptionBuilder from '#cli/builders/markdownOptionBuilder';
import pdfOptionBuilder from '#cli/builders/pdfOptionBuilder';
import { CE_COMMAND_LIST } from '#cli/const-enum/CE_COMMAND_LIST';
import type IBuildCommandOption from '#configs/interfaces/IBuildCommandOption';
import type ICommonOption from '#configs/interfaces/ICommonOption';
import type IErdiaHtmlOption from '#configs/interfaces/IErdiaHtmlOption';
import type IErdiaImageOption from '#configs/interfaces/IErdiaImageOption';
import type IErdiaMarkdownOption from '#configs/interfaces/IErdiaMarkdownOption';
import type IErdiaPDFOption from '#configs/interfaces/IErdiaPDFOption';
import preLoadConfig from '#configs/preLoadConfig';
import logger from '#tools/logger';
import sourceMapSupport from 'source-map-support';
import yargsAnyType, { Argv, CommandModule } from 'yargs';
import { cleanDoc, createHtmlDoc, createImageDoc, createMarkdownDoc, createPdfDoc, initErdia } from './erdia';

const log = logger();

sourceMapSupport.install();

const buildCmdModule: CommandModule<IBuildCommandOption, IBuildCommandOption> = {
  command: CE_COMMAND_LIST.BUILD,
  aliases: CE_COMMAND_LIST.BUILD_ALIAS,
  describe: 'create route.ts file in your directory using by tsconfig.json',
  handler: async () => {
    try {
      await initCommandSyncHandler();
    } catch (caught) {
      const err = isError(caught, new Error('unknown error raised'));
      log.error(err);
    }
  },
};

// Yargs default type using object type(= {}). But object type cause error that
// fast-maker cli option interface type. So we make concrete type yargs instance
// make using by any type.
const yargs: Argv<IErdiaMarkdownOption | IErdiaHtmlOption | IErdiaPDFOption | IErdiaImageOption> = yargsAnyType as any;

// eslint-disable-next-line @typescript-eslint/no-unused-expressions
yargs(process.argv.slice(2))
  .command<IErdiaMarkdownOption>({
    command: 'md',
    builder: (args) => {
      return [commonOptionBuilder, documentOptionBuilder, markdownOptionBuilder].reduce(
        (arg, builder) => builder(arg),
        args as any,
      );
    },
    handler: async (argv) => {
      log.level = argv.verbose ? 'verbose' : 'info';
      await createMarkdownDoc({ ...argv, type: 'markdown' });
    },
  })
  .command<IErdiaHtmlOption>({
    command: 'html',
    builder: (args) => {
      return [commonOptionBuilder, documentOptionBuilder, htmlOptionBuilder].reduce(
        (arg, builder) => builder(arg),
        args as any,
      );
    },
    handler: async (argv) => {
      log.level = argv.verbose ? 'verbose' : 'info';
      await createHtmlDoc({ ...argv, type: 'html' });
    },
  })
  .command<IErdiaPDFOption>({
    command: 'pdf',
    builder: (args) => {
      return [commonOptionBuilder, documentOptionBuilder, pdfOptionBuilder].reduce(
        (arg, builder) => builder(arg),
        args as any,
      );
    },
    handler: async (argv) => {
      log.level = argv.verbose ? 'verbose' : 'info';
      await createPdfDoc({ ...argv, type: 'pdf' });
    },
  })

  .command<IErdiaImageOption>({
    command: 'image',
    builder: (args) => {
      return [commonOptionBuilder, imageOptionBuilder].reduce((arg, builder) => builder(arg), args as any);
    },
    handler: async (argv) => {
      log.level = argv.verbose ? 'verbose' : 'info';
      await createImageDoc({ ...argv, type: 'image' });
    },
  })
  .command<ICommonOption>({
    command: 'clean',
    builder: (args) => {
      return commonOptionBuilder(args) as any;
    },
    handler: async (argv) => {
      log.level = argv.verbose ? 'verbose' : 'info';
      await cleanDoc(argv);
    },
  })
  .command({
    command: 'init',
    handler: async (argv) => {
      log.level = argv.verbose ? 'verbose' : 'info';
      await initErdia();
    },
  })
  .demandCommand()
  .recommendCommands()
  .config(preLoadConfig())
  .help().argv;
